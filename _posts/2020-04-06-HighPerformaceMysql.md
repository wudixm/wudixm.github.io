## 第四章知识点

## 4.1 选择优化的数据类型

- 正确存储数据的最小类型，更小的通常更快，占用更少的磁盘、内存和CPU缓存，处理时需要的CPU周期也更少
- 整形比字符操作代价更低，因为字符集和校对规则（排序规则）使字符比较比整形比较更复杂
- 要使用MySQL内建的类型（date,time,datatime）而不是字符串来存储日期和时间
- 应该用整形存储IP 地址
- 尽量避免Null--通常情况下最好指定列为NOT NULL，除非真的需要存储NULL 值
- 如果查询中包含可为NULL 的列，对MySQL 来说更难优化，因为可为NULL的列使得索引、索引统计和值比较都更为复杂。可为NULL 的列会使用更多的存储空间，在MySQL 里也需要特殊处理。当可为NULL 的列被索引时，每个索引记录需要一个额外的字节
- 通常把可为NULL 的列改为NOT NULL带来的性能提升比较小，所以（调优时）没有必要首先在现有schema 中查找并修改这种情况
- **如果计划在列上建索引，就应该尽量避免设计成可为NULL 的列。**
- InnoDB 使用单独的位（bit）来存储NULL 值，所以对于稀疏数据有很好的空间效率。不适用于MyISAM
- DateTime 和TIMESTAMP都可以存储相同类型的数据：时间和日期，精确到秒。然而TimeStamp只使用DateTime 一半的存储空间，并且会根据时区变化，具有特殊的自动更新能力。另一方面，TimeStamp 允许的时间范围要小得多，有时候它的特殊能力会成为障碍


### 4.1.1 整数类型

- 有两种类型的数字：整数和实数。整数可以使用：tinyint, smallint, mediumint, int, bigint，分别使用了8,16,24,32,64 位存储空间
- 整数类型有可选的unsigned 属性，表示不允许负值，可以使正数的上限提高一倍。例如tinyint unsigned 可以存储0-255，而tinyint 存储范围是-128 - 127
- **有符号和无符号类型使用相同的存储空间，并具有相同的性能，因此可以根据实际情况选择合适的类型。**
- 你的选择决定MySQL是怎么在内存和磁盘中保存数据。然而整数计算一般使用64 位的bigint整数（一些聚合函数例外，它们使用decimal 或double 进行计算）
- MySQL 可以为整数类型指定宽度，例如int(11)，对大多数应该这是没有意义的：它不会限制值的合法范围，只是规定了MySQL 的一些交互工具（例如MySQL 命令行客户端）用来显示字符的个数。**对于存储和计算来说，int(1) 和int(20)是相同的

### 4.1.2 实数类型

- 实数是带有小数部分的数字。可以使用decimal 存储比bigint 还大的整数。MySQL 支持精确类型，也支持不精确类型
- FLOAT 和DOUBLE类型支持使用标准的浮点运算进行近似计算
- decimal 类型用于存储精确的小数，MySQL 5.0 以及更高的版本中，MySQL 服务器自身实现了decimal 的高精度计算。相对而言，CPU 直接支持原生浮点计算，所以浮点运算明显更快
- 浮点和decimal 类型都支持指定精度。MySQL 5.0 和更高版本将数字打包到保存到一个二进制字符串中（每4 个字节存9 个数字）例如，`decimal(18,9)` 小数点两边将各存储9 个数字，一共使用9 个字节：小数点前4 个字节，小数点1 个字节，后面4 个字节。
- MySQL 5.0 及更高版本中的decimal 类型允许最多65 个数字。早期的限制是254 个数字。早期版本实际上并不能在计算中使用这么大的数字，因为decimal 只是一种存储格式，在计算中decimal 会转换到double类型。
- 浮点类型在存储同样范围的值时，通常比decimal 使用更少的空间。float 占用4 个字节，double 占用8 个字节。和整数一样，能选择的只是存储类型，MySQL 使用double 作为内部浮点计算的类型
- 因为需要额外空间和计算开销，所以应该尽量只在对小数进行精确计算时才使用decimal——例如存储财务数据。在数据量比较大的时候，可以考虑使用bigint代替decimal，将需要存储的单位根据小数的位数乘以相应的倍数即可。比如乘以1百万，然后将结果存储在bigint 里，这样可以同时避免浮点存储计算不精确和decimal 精确计算代价高的问题

### 4.1.3 字符串类型

- MySQL 从4.1 开始，每个字符串列可以定义自己的字符集和排序规则，或者说校对规则(collation)。这些东西很大程序上影响性能

#### varchar 和char 类型

##### varchar

- 存储可变长度字符串。它比定长类型更节省空间，因为它仅使用必要的空间（越短的字符串使用越少的空间）。有一种例外情况，如果MySQL 表使用`row_format=fixed` 创建的话，每一行都会使用定长存储，这会很浪费空间
- varchar 需要使用1 个或者2 个额外的字节记录字符串的长度：如果列长最大长度小于或等于255 字节，则只使用1 个字节表示，否则使用2 个字节。假设采用latin1 字符集，一个varchar(10) 的列需要11 个字节的存储空间，varchar(1000) 的列需要1002 个字节，因为需要2 个字节存储长度信息
- varchar 节省了存储空间，所以对性能也有帮助。由于行是变长的，在update 时可能使行变得比原来更长，这就导致需要做额外的工作。不同的存储引擎处理方式是不一样的，MyISAM 会将行拆成不同的片段存储，InnoDB 则需要分裂页来使行可以放进页内
- 以下情况使用varchar 合适：
  - 字符串列的最大长度比平均长度大很多
  - 列的更新很少，所以碎片不是问题
  - 使用了像UTF-8 这样复杂的字符集，每个字符都使用不同的字节数进行存储
  - InnoDB 会更灵活，它可以把过长的varchar 存储为blob

char

- 定长的，MySQL 问题根据定义的字符串长度分配足够的空间，会删除末尾的空格。
- 适合存储很短的字符串，或者所有值都接近同一个长度。例如char 非常适合存储密码的MD5值。
- 对于经常变更的数据，char 也比varchar 更好，因为定长的char 类型不容易产生碎片
- 对于非常短的列，char比varchar 在存储空间上也更有效率。例如用char(1) 来存储只有Y 和N 的值，只需要一个字节。**但是varchar(1) 却需要两个字节，因为还有一个记录长度的额外字节**

正文

- 与char 和varchar 类似的类型还有binary 和varbinary，它们存储的是二进制的字符串。二进制字符串跟常规字符串非常相似，但是二进制字符串存储的是字节码而不是字符，用`\0` 填充，而不是空格。在检索时也不会去掉填充值
- 二进制比较的优势并不仅仅体现在大小写敏感上。MySQL 比较binary 字符串时，每次按一个字节，并且根据该字节的数值进行比较。二进制比较比字符比较简单很多，所以更快。

- 使用varchar(5) 和varchar(200) 存储`hello` 的空间开销是一样的，但是使用更短的列有很大优势，更长的列会消耗更多的内存，因为MySQL 通常会分配固定大小的内存块来保存内部值。尤其是使用内存临时表进行排序或操作时，会特别糟糕。在利用磁盘临时表进行排序的时候也同样糟糕。
- **所以，最好的策略是只分配真正需要的空间。**

#### blob 和text 类型

- blob 和text 都是为存储很大的数据而设计的字符串数据类型，分别**采用二进制和字符方式存储**。
- 